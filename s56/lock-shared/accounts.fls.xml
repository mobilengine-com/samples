<?xml version="1.0" encoding="UTF-8"?>
<form xmlns="http://schemas.mobilengine.com/fls/v2" id="accounts" menuName="accounts" platforms="web">
	<declarations>
		<let id='i' shape='scalar' value='{1}' />
		<let id='ii' shape='scalar' value='{SELECT i+1 WHERE sleep(1000) IS NULL}' />
	</declarations>
	<submitbutton text='save next form' nextForm='{forms.accounts}' id='cbSaveNext' testId='cbSaveNext' />
	<combinedbutton text='save no close (not)' id='cbSaveNoClose' testId='cbSaveNoClose'>
		<actionbutton><set value='{SELECT i+1 WHERE sleep(1000) IS NULL}' target='i' /></actionbutton>
		<actionbutton><set value='{SELECT i+1 WHERE sleep(1000) IS NULL}' target='i' /></actionbutton>
	</combinedbutton>
	<!-- 
		<submitbutton closeForm='{false}'/>
	-->
	<submitbutton text='save' nextForm='{forms.accounts}' id='cbSave' testId='cbSave'/> <!-- waitForRfs='{false}' closeForm='{false}' -->
	<numberbox id='nWait' label='wait' number='{1000}'/>
	<numberbox id='nWaitLocked' label='wait locked' number='{1000}'/>
	<!--
		recordLocal='{SELECT r.guid, tbName.text name, n1.number, r.counter, r.ver}'
		recordLocal='{SELECT rec.guid, tbName.text name, n1.number, rec.counter, rec.ver}'
	-->
	<table id='t' record='r' recordLocal='{SELECT r.acc_num, tbName.text holder_name, (CASE WHEN cbValid.checked THEN 1 ELSE 0 END) valid, nbBalance.number balance, r.ver, fChanged}'
		recordset='{loadnewerfromserver:select t.acc_num, t.holder_name, t.valid, b.balance, t.ver, false fChanged from account t join balance b on b.acc_num = t.acc_num}'>
		<row>
			<declarations>
				<let id='rec' shape='record' value='{select r.acc_num, r.holder_name, r.valid, r.balance, r.ver, fChanged}' />
				<let id='recUpd' shape='record' value='{select tbNum.text acc_num,tbName.text holder_name, (case when cbValid.checked then 1 else 0 end) valid, nbBalance.number balance, r.ver+1 ver}' />
				<let id='fChanged' shape='scalar' access='public' value='{not (r.holder_name = tbName.text and cbValid.checked = (r.valid=1) and nbBalance.number = r.balance)}' />
			</declarations>
			<!-- 
			<cell><numberbox number='{~3}'/></cell>
			<cell><numberbox number='{1^3}'/></cell>
			<cell><numberbox number='{1&amp;3}'/></cell>
			<cell><numberbox number='{1|3}'/></cell>-->
			<cell>
				
				<if cond='{rec.acc_num is null}'>
					<textbox id='tbNum' hint='account number' text='{r.acc_num}'/>
				</if>
				<if cond='{rec.acc_num is not null}'>
					<textview text='{r.acc_num}'/>
				</if>
			</cell>
			<cell><textbox id='tbName' hint='holder name' text='{r.holder_name}'/></cell>
			<cell><checkbox id='cbValid' text='valid' checked='{r.valid=1}'/></cell>
			<cell><numberbox id='nbBalance' hint='balance' number='{r.balance}' float='false'/></cell>
			<cell>	<textview text='{ " v"||toString(r.ver) }' />
			</cell>
		</row>
	</table>
	<addbutton records='{select null acc_num, null holder_name, 1 valid, 0 balance, 0 ver, true fChanged}' table='t' text='+'/>
	
</form>